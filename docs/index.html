<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>持ち物管理リスト</title>
  <style>
    :root {
      --bg: #fafafa;
      --card: #ffffff;
      --text: #222;
      --muted: #666;
      --accent: #0b79d0;
      --border: #e6e6e6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN",
                   "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", "YuGothic", "Meiryo", sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 24px;
    }
    .container {
      max-width: 860px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.04);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 20px;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .field label { font-size: 13px; color: var(--muted); }
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0 12px;
    }
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn.primary { border-color: #0b79d0; color: #0b79d0; }
    .btn.danger { border-color: #d00b0b; color: #d00b0b; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .subtle { color: var(--muted); font-size: 13px; margin-bottom: 16px; }
    .section-title {
      margin: 18px 0 8px;
      font-weight: 700;
      font-size: 15px;
      color: var(--accent);
    }
    .required { color: #d00b0b; font-weight: 700; font-size: 12px; margin-left: 6px; }
    .row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dashed var(--border);
    }
    .row:last-child { border-bottom: none; }
    .label { font-weight: 600; }
    .unit { color: var(--muted); min-width: 2em; text-align: left; }
    input[type="number"] {
      width: 110px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      text-align: right;
      background: #fff;
    }
    .divider {
      margin: 18px 0;
      color: var(--muted);
      text-align: center;
      letter-spacing: 0.2em;
      font-size: 13px;
    }
    .item-names {
      padding: 6px 0 12px 0;
    }
    .item-names label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .item-names textarea {
      width: 100%;
      min-height: 64px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      background: #fff;
      resize: vertical;
    }
    .total {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      background: #f5f8fb;
      border: 1px solid #e8eef5;
      border-radius: 10px;
      padding: 12px 14px;
      margin: 8px 0 2px;
    }
    .total .title { font-weight: 700; }
    .total .value { font-weight: 800; font-size: 18px; }
    .note { color: var(--muted); font-size: 12px; margin-bottom: 10px; }
    textarea {
      width: 100%;
      min-height: 110px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      background: #fff;
    }
    @media (max-width: 520px) {
      .row {
        grid-template-columns: 1fr auto;
      }
      .unit { grid-column: 2; justify-self: start; }
    }
  </style>
  <script src="config.js"></script>
</head>
<body>
  <div class="container">
    <h1>持ち物管理アプリ用リスト</h1>
    <div class="subtle">数値を入力すると自動で合計が計算されます。</div>

    <!-- 受講生向けのため、エクスポート/インポート等の操作は非表示にしました -->

    <!-- お名前（必須） -->
    <div class="grid-2" style="margin-bottom:10px;">
      <div class="field" style="grid-column: 1 / -1;">
        <label for="studentName">お名前<span class="required">（必須）</span></label>
        <input type="text" id="studentName" data-key="studentName" placeholder="例：山田 太郎" />
      </div>
    </div>

    <div class="section-title">衣類</div>
    <div class="row">
      <div class="label">【アウター】</div>
      <input type="number" inputmode="numeric" min="0" step="1" value="0" data-key="outer" data-group="clothes" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【トップス】</div>
      <input type="number" inputmode="numeric" min="0" step="1" value="0" data-key="tops" data-group="clothes" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【ボトムス】</div>
      <input type="number" inputmode="numeric" min="0" step="1" value="0" data-key="bottoms" data-group="clothes" />
      <div class="unit">枚</div>
    </div>

    <div class="divider">ーーーーーーーーーーーーーーーーーー</div>

    <div class="total" aria-live="polite">
      <div class="title">服の合計：</div>
      <div class="value"><span id="clothesTotal">0</span> 枚</div>
    </div>
    <div class="note">（アウター・トップス・ボトムスの合計）</div>

    <div class="divider">ーーーーーーーーーーーーーーーーーー</div>

    <div class="section-title">その他の持ち物</div>

    <div class="row">
      <div class="label">【下着】</div>
      <input type="number" min="0" step="1" value="0" data-key="underwear" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【その他衣類】</div>
      <input type="number" min="0" step="1" value="0" data-key="otherClothes" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【タオル類】</div>
      <input type="number" min="0" step="1" value="0" data-key="towels" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【靴】</div>
      <input type="number" min="0" step="1" value="0" data-key="shoes" />
      <div class="unit">足</div>
    </div>
    <div class="row">
      <div class="label">【カバン】</div>
      <input type="number" min="0" step="1" value="0" data-key="bags" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【アクセサリー/帽子】</div>
      <input type="number" min="0" step="1" value="0" data-key="accessories" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【ビューティー・ケア用品】</div>
      <input type="number" min="0" step="1" value="0" data-key="beauty" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【書籍】</div>
      <input type="number" min="0" step="1" value="0" data-key="books" />
      <div class="unit">冊</div>
    </div>
    <div class="row">
      <div class="label">【書類】</div>
      <input type="number" min="0" step="1" value="0" data-key="documents" />
      <div class="unit">冊</div>
    </div>
    <div class="row">
      <div class="label">【家具】</div>
      <input type="number" min="0" step="1" value="0" data-key="furniture" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【家電・ガジェット】</div>
      <input type="number" min="0" step="1" value="0" data-key="gadgets" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【文房具】</div>
      <input type="number" min="0" step="1" value="0" data-key="stationery" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【キッチンアイテム/ 調理道具】</div>
      <input type="number" min="0" step="1" value="0" data-key="kitchenTools" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【食器】</div>
      <input type="number" min="0" step="1" value="0" data-key="tableware" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【調味料】</div>
      <input type="number" min="0" step="1" value="0" data-key="seasonings" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【食料品（ストック）】</div>
      <input type="number" min="0" step="1" value="0" data-key="foodStock" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【洗剤】</div>
      <input type="number" min="0" step="1" value="0" data-key="detergent" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【掃除道具】</div>
      <input type="number" min="0" step="1" value="0" data-key="cleaningTools" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【医薬品・サプリメント】</div>
      <input type="number" min="0" step="1" value="0" data-key="meds" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【カード類】</div>
      <input type="number" min="0" step="1" value="0" data-key="cards" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【通帳】</div>
      <input type="number" min="0" step="1" value="0" data-key="bankbooks" />
      <div class="unit">冊</div>
    </div>
    <div class="row">
      <div class="label">【雑貨・小物】</div>
      <input type="number" min="0" step="1" value="0" data-key="generalGoods" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【趣味のアイテム】</div>
      <input type="number" min="0" step="1" value="0" data-key="hobby" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【思い出の品】</div>
      <input type="number" min="0" step="1" value="0" data-key="memories" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【防災アイテム/備蓄】</div>
      <input type="number" min="0" step="1" value="0" data-key="disaster" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【その他】</div>
      <input type="number" min="0" step="1" value="0" data-key="others" />
      <div class="unit">個</div>
    </div>

    <div class="divider">ーーーーーーーーーーーーーー</div>

    <div class="total" aria-live="polite">
      <div class="title">持ち物全ての合計：</div>
      <div class="value"><span id="grandTotal">0</span> 個</div>
    </div>

    <div class="divider">ーーーーーーーーーーーーーー</div>

    <div class="section-title">【持ち物の傾向・価値観リスト】</div>
    <textarea data-key="traits" placeholder="例：少数精鋭、黒系が多い、用途が重複しないように選ぶ など"></textarea>

    <div class="section-title">【失敗したモノの傾向リスト】</div>
    <textarea data-key="failures" placeholder="例：サイズが合っていない、色が派手すぎた、似た用途の重複購入 など"></textarea>

    <!-- 提出ボタン（フォームの一番最後に配置） -->
    <div class="toolbar" style="justify-content:flex-end; margin-top: 16px;">
      <button class="btn primary" id="submitBtn">提出（送信）</button>
      <span id="submitStatus" class="subtle" aria-live="polite"></span>
    </div>
  </div>

  <script>
    (function () {
      const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE)
        ? String(window.APP_CONFIG.API_BASE).replace(/\/+$/, '')
        : '';
      const STORAGE_KEY = 'packingListState_v2';
      const numberInputs = Array.from(document.querySelectorAll('input[type="number"]'));
      const textareas = Array.from(document.querySelectorAll('textarea'));
      const textInputs = Array.from(document.querySelectorAll('input[type="text"]'));
      const allInputs = [...numberInputs, ...textareas, ...textInputs];
      const clothesInputs = numberInputs.filter(el => el.dataset.group === 'clothes');
      const clothesTotalEl = document.getElementById('clothesTotal');
      const grandTotalEl = document.getElementById('grandTotal');

      const submitBtn = document.getElementById('submitBtn');
      const submitStatus = document.getElementById('submitStatus');
      // 管理者が admin.html で保存した提出先URL（学生側は編集不可）
      const ADMIN_SUBMIT_ENDPOINT_KEY = 'admin_submit_endpoint';
      // Default endpoint: same-origin or external API base
      const SUBMIT_ENDPOINT_DEFAULT = (API_BASE ? API_BASE + '/submissions' : '/submissions');

      function toInt(val) {
        const n = parseInt(val, 10);
        return Number.isFinite(n) && n >= 0 ? n : 0;
      }

      function updateTotals() {
        const clothesTotal = clothesInputs.reduce((sum, el) => sum + toInt(el.value), 0);
        const grandTotal = numberInputs.reduce((sum, el) => sum + toInt(el.value), 0);
        clothesTotalEl.textContent = clothesTotal;
        grandTotalEl.textContent = grandTotal;
      }

      function getState() {
        const state = {};
        numberInputs.forEach(el => { state[el.dataset.key] = toInt(el.value); });
        textareas.forEach(el => { state[el.dataset.key] = String(el.value || ''); });
        textInputs.forEach(el => { state[el.dataset.key] = String(el.value || ''); });
        return state;
      }

      function setState(state) {
        numberInputs.forEach(el => {
          const v = state?.[el.dataset.key];
          if (typeof v === 'number' || typeof v === 'string') el.value = v;
        });
        textareas.forEach(el => {
          const v = state?.[el.dataset.key];
          if (typeof v === 'string') el.value = v;
        });
        textInputs.forEach(el => {
          const v = state?.[el.dataset.key];
          if (typeof v === 'string' || typeof v === 'number') el.value = v;
        });
        updateTotals();
      }

      // 各行にアイテム名テキストエリアを追加（1行1アイテム、改行区切り）
      function attachItemNameAreas() {
        const rows = Array.from(document.querySelectorAll('.row'));
        for (const row of rows) {
          const qtyInput = row.querySelector('input[type="number"][data-key]');
          const labelEl = row.querySelector('.label');
          if (!qtyInput || !labelEl) continue;
          const baseKey = qtyInput.dataset.key;
          const namesKey = baseKey + '_names';

          // 既に作成済みならスキップ
          if (row.nextElementSibling && row.nextElementSibling.classList?.contains('item-names')) continue;

          const wrap = document.createElement('div');
          wrap.className = 'item-names';
          const id = `names_${baseKey}`;
          wrap.innerHTML = `
            <textarea id="${id}" data-key="${namesKey}"></textarea>
          `;
          row.insertAdjacentElement('afterend', wrap);
        }
      }

      function save() {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(getState())); } catch (e) {}
      }

      function restoreFromLocalStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) setState(JSON.parse(raw));
        } catch (e) {}
      }

      function download(filename, content, type='application/octet-stream') {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
      }

      function decodeStateFromHash(hash) {
        try {
          if (!hash.startsWith('#data=')) return null;
          const b64 = hash.slice(6);
          const json = decodeURIComponent(escape(atob(b64)));
          return JSON.parse(json);
        } catch (e) { return null; }
      }

      // イベント: 入力で合計更新 + 自動保存（軽いデバウンス）
      let t = null;
      function onAnyChange() {
        updateTotals();
        if (t) clearTimeout(t);
        t = setTimeout(save, 150);
      }
      allInputs.forEach(el => {
        el.addEventListener('input', onAnyChange, { passive: true });
        el.addEventListener('change', onAnyChange, { passive: true });
      });

      // 学生向けに余分なボタンは削除済み

      function collectForSubmit() {
        const state = getState();
        // すべての行（カテゴリ）を詳細として集約
        const rows = Array.from(document.querySelectorAll('.row')).map(r => {
          const label = (r.querySelector('.label')?.textContent || '').trim();
          const unit = (r.querySelector('.unit')?.textContent || '').trim();
          const input = r.querySelector('input[type="number"]');
          const qty = input ? toInt(input.value) : 0;
          let names = [];
          try {
            const baseKey = input?.dataset.key;
            const namesEl = r.nextElementSibling?.classList?.contains('item-names')
              ? r.nextElementSibling.querySelector('textarea[data-key]')
              : null;
            const raw = namesEl ? String(namesEl.value || '') : '';
            names = raw.split(/\r?\n/).map(s => s.trim()).filter(s => s.length > 0);
          } catch (e) {}
          return { label, unit, qty, key: input?.dataset.key || null, names };
        });
        const payload = {
          meta: {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: location.href
          },
          // 受講生識別情報
          identity: {
            name: (state.studentName || '').trim()
          },
          totals: {
            clothes: Number(document.getElementById('clothesTotal')?.textContent || 0),
            grand: Number(document.getElementById('grandTotal')?.textContent || 0)
          },
          notes: {
            traits: state.traits || '',
            failures: state.failures || ''
          },
          items: rows
        };
        const endpoint = (localStorage.getItem(ADMIN_SUBMIT_ENDPOINT_KEY) || '').trim() || SUBMIT_ENDPOINT_DEFAULT;
        return { payload, endpoint };
      }

      async function submitData() {
        submitStatus.textContent = '';
        const { payload, endpoint } = collectForSubmit();
        if (!endpoint) { submitStatus.textContent = '現在提出を受け付けていません。管理者に確認してください。'; return; }
        // お名前（必須）
        if (!payload.identity.name) {
          submitStatus.textContent = 'お名前を入力してください（必須）';
          const el = document.getElementById('studentName');
          if (el) el.focus();
          return;
        }
        // 受講生情報のバリデーションは不要に
        try {
          submitBtn.disabled = true;
          submitStatus.textContent = '送信中...';
          const isCross = /^https?:\/\//i.test(endpoint) && (!location.origin || !endpoint.startsWith(location.origin));
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            mode: isCross ? 'cors' : 'same-origin',
            credentials: isCross ? 'include' : 'same-origin',
            body: JSON.stringify({ payload })
          });
          if (res.status === 401) {
            submitStatus.textContent = 'ログインが必要です。ログインページへ移動します...';
            const loginBase = API_BASE || '';
            const nextPath = '/student/';
            setTimeout(() => { location.href = `${loginBase}/auth/login?next=${encodeURIComponent(nextPath)}`; }, 600);
            return;
          }
          if (!res.ok) throw new Error('HTTP ' + res.status);
          // 期待応答: { ok: true }
          let msg = '送信しました';
          try { const j = await res.json(); if (j && j.message) msg = j.message; } catch (e) {}
          submitStatus.textContent = msg;
        } catch (e) {
          submitStatus.textContent = '送信に失敗しました。提出先URLやCORS設定を確認してください';
        } finally {
          submitBtn.disabled = false;
        }
      }
      submitBtn.addEventListener('click', submitData);

      // 受講生情報の厳密な日付チェックは削除

      // 初期表示: アイテム名エリアを付与 → URLハッシュ優先で復元、なければLocalStorageから復元
      attachItemNameAreas();
      const fromHash = decodeStateFromHash(location.hash || '');
      if (fromHash) {
        setState(fromHash);
        save();
      } else {
        restoreFromLocalStorage();
        updateTotals();
      }
    })();
  </script>
</body>
</html>
