<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>管理ビューア（Packing List）</title>
  <style>
    :root {
      --bg: #fafafa; --card:#fff; --text:#222; --muted:#666; --border:#e6e6e6; --accent:#0b79d0;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Sans","Yu Gothic",Meiryo,sans-serif; background:var(--bg); color:var(--text);}
    .wrap{ max-width:1100px; margin:0 auto; padding:20px; }
    h1{ font-size:20px; margin:0 0 10px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin:12px 0; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ color:var(--muted); font-size:12px }
    input[type="text"], textarea{ width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:14px; background:#fff }
    textarea{ min-height:120px; resize:vertical }
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; }
    .btn{ appearance:none; border:1px solid var(--border); background:#fff; color:var(--text); border-radius:8px; padding:8px 10px; font-size:13px; cursor:pointer }
    .btn.primary{ border-color:var(--accent); color:var(--accent) }
    .btn.danger{ border-color:#d00b0b; color:#d00b0b }
    .muted{ color:var(--muted); font-size:12px }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-top:1px solid var(--border); padding:8px; text-align:left; vertical-align:top; }
    th{ background:#f5f8fb }
    .pill{ display:inline-block; border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:12px; color:var(--muted) }
    .flex{ display:flex; gap:8px; align-items:center }
    .right{ text-align:right }
    .mb8{ margin-bottom:8px }
    .mb12{ margin-bottom:12px }
    .mb4{ margin-bottom:4px }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>管理ビューア（Packing List）</h1>
    <div class="muted mb12">共有リンク（#data=...）や JSON を貼付／読込して、提出内容を一覧表示・CSV出力します。将来的な認証API連携に備えた設定欄あり。</div>

    <div class="card">
      <h2 class="mb8" style="font-size:16px">設定</h2>
      <div class="grid-2 mb12">
        <div class="field">
          <label for="submitEndpoint">提出受け取りURL（学生用に自動反映）</label>
          <input type="text" id="submitEndpoint" placeholder="https://script.google.com/.../exec" />
        </div>
        <div class="field">
          <label for="apiEndpoint">一覧取得API（例：GASの読み出し用URL）</label>
          <input type="text" id="apiEndpoint" placeholder="https://script.google.com/.../exec" />
        </div>
      </div>
      <div class="grid-2 mb12">
        <div class="field">
          <label for="apiToken">認証トークン（例：Bearerトークン）</label>
          <input type="text" id="apiToken" placeholder="例：長いAPIトークン" />
        </div>
        <div class="field">
          <label for="sortBy">並び替え</label>
          <select id="sortBy">
            <option value="latest">最新順（デフォルト）</option>
            <option value="birthdate">生年月日順</option>
            <option value="class">クラス順</option>
            <option value="name">名前順（あれば）</option>
          </select>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="saveSettingsBtn">設定を保存</button>
        <button class="btn primary" id="reloadBtn">最新を取得</button>
        <span class="muted" id="apiSaveStatus" aria-live="polite"></span>
        <span class="muted" id="loadStatus" aria-live="polite" style="margin-left:8px"></span>
      </div>
    </div>

    <div class="card">
      <h2 class="mb8" style="font-size:16px">提出一覧</h2>
      <div class="muted mb8" id="summary">0 件</div>
      <div class="mb12">
        <table id="table">
          <thead>
            <tr>
              <th>生年月日(8桁)</th>
              <th>クラス</th>
              <th class="right">服合計</th>
              <th class="right">総合計</th>
              <th>傾向</th>
              <th>失敗傾向</th>
              <th>明細（カテゴリ:数量）</th>
              <th>提出URL</th>
              <th>時刻</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="toolbar">
        <button class="btn" id="exportCsvBtn">一覧をCSV出力</button>
        <button class="btn" id="exportJsonBtn">一覧をJSON出力</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const STORAGE = {
        // 学生提出用エンドポイント
        submitEndpoint: 'admin_submit_endpoint',
        // 管理画面：一覧取得API設定
        apiEndpoint: 'admin_apiEndpoint',
        apiToken: 'admin_apiToken',
        sortBy: 'admin_sortBy',
      };

      const submitEndpointEl = document.getElementById('submitEndpoint');
      const apiEndpointEl = document.getElementById('apiEndpoint');
      const apiTokenEl = document.getElementById('apiToken');
      const sortByEl = document.getElementById('sortBy');
      const saveSettingsBtn = document.getElementById('saveSettingsBtn');
      const reloadBtn = document.getElementById('reloadBtn');
      const apiSaveStatus = document.getElementById('apiSaveStatus');

      const loadStatus = document.getElementById('loadStatus');

      const exportCsvBtn = document.getElementById('exportCsvBtn');
      const exportJsonBtn = document.getElementById('exportJsonBtn');

      const tableBody = document.querySelector('#table tbody');
      const summaryEl = document.getElementById('summary');

      function saveApiSettings(){
        try {
          localStorage.setItem(STORAGE.submitEndpoint, submitEndpointEl.value || '');
          localStorage.setItem(STORAGE.apiEndpoint, apiEndpointEl.value || '');
          localStorage.setItem(STORAGE.apiToken, apiTokenEl.value || '');
          localStorage.setItem(STORAGE.sortBy, sortByEl.value || 'latest');
          apiSaveStatus.textContent = '保存しました';
          setTimeout(()=> apiSaveStatus.textContent = '', 1500);
        } catch(e) {}
      }

      function loadApiSettings(){
        try {
          submitEndpointEl.value = localStorage.getItem(STORAGE.submitEndpoint) || '';
          apiEndpointEl.value = localStorage.getItem(STORAGE.apiEndpoint) || '';
          apiTokenEl.value = localStorage.getItem(STORAGE.apiToken) || '';
          sortByEl.value = localStorage.getItem(STORAGE.sortBy) || 'latest';
        } catch(e) {}
      }

      saveSettingsBtn.addEventListener('click', () => { saveApiSettings(); fetchFromApi(true); });
      reloadBtn.addEventListener('click', () => { fetchFromApi(true); });
      loadApiSettings();

      // Data model in memory
      /** @type {Array<any>} */
      let submissions = [];

      function normalize(obj){
        const identity = obj.identity || {};
        const totals = obj.totals || {};
        const notes = obj.notes || {};
        const meta = obj.meta || {};
        const items = Array.isArray(obj.items) ? obj.items : [];
        const timestamp = meta.timestamp || new Date().toISOString();
        const sourceUrl = meta.sourceUrl || meta.url || '';
        return {
          name: identity.name || '',
          birthdate8: identity.birthdate8 || '',
          className: identity.className || '',
          clothes: Number(totals.clothes || 0),
          grand: Number(totals.grand || 0),
          traits: notes.traits || '',
          failures: notes.failures || '',
          items,
          url: sourceUrl,
          time: timestamp
        };
      }

      function render(){
        tableBody.innerHTML = '';
        const sorted = sortSubmissions([...submissions], sortByEl.value || 'latest');
        sorted.forEach(s => {
          const tr = document.createElement('tr');
          const itemsText = s.items.map(it => `${(it.label||'').replace(/[\s\u3000]/g,'').replace(/[【】]/g,'')}:${it.qty}`).join(' / ');
          tr.innerHTML = `
            <td>${escapeHtml(s.birthdate8)}</td>
            <td>${escapeHtml(s.className)}</td>
            <td class="right">${s.clothes}</td>
            <td class="right">${s.grand}</td>
            <td>${escapeHtml(s.traits)}</td>
            <td>${escapeHtml(s.failures)}</td>
            <td>${escapeHtml(itemsText)}</td>
            <td>${s.url ? `<a href="${escapeAttr(s.url)}" target="_blank" rel="noopener">リンク</a>` : ''}</td>
            <td><span class="pill">${escapeHtml(new Date(s.time).toLocaleString())}</span></td>
          `;
          tableBody.appendChild(tr);
        });
        summaryEl.textContent = `${submissions.length} 件 / 合計（grand）：${sumBy(submissions,'grand')} ／ 服合計：${sumBy(submissions,'clothes')}`;
      }

      function sumBy(arr, key){ return arr.reduce((a,b)=> a + Number(b[key]||0), 0); }
      function escapeHtml(s){ return String(s).replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); }
      function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }

      function addSubmission(obj){ submissions.push(normalize(obj)); }

      function sortSubmissions(arr, how){
        if (how === 'birthdate'){
          return arr.sort((a,b)=> String(a.birthdate8||'').localeCompare(String(b.birthdate8||'')) );
        } else if (how === 'class'){
          return arr.sort((a,b)=> String(a.className||'').localeCompare(String(b.className||'')) );
        } else if (how === 'name'){
          return arr.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')) );
        }
        // latest
        return arr.sort((a,b)=> new Date(b.time).getTime() - new Date(a.time).getTime());
      }

      function toCSV(){
        const header = ['name','studentId','className','clothes','grand','traits','failures','time','url','itemsJson'];
        const lines = [header.join(',')];
        for(const s of submissions){
          const esc = v => '"' + String(v).replace(/"/g,'""') + '"';
          lines.push([
            esc(s.name), esc(s.studentId), esc(s.className), s.clothes, s.grand,
            esc(s.traits), esc(s.failures), esc(s.time), esc(s.url), esc(JSON.stringify(s.items))
          ].join(','));
        }
        return lines.join('\n');
      }

      function download(name, content, type='application/octet-stream'){
        const blob = new Blob([content], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name; a.click();
        URL.revokeObjectURL(url);
      }

      exportCsvBtn.addEventListener('click', ()=> download(`packing-submissions-${Date.now()}.csv`, toCSV(), 'text/csv;charset=utf-8'));
      exportJsonBtn.addEventListener('click', ()=> download(`packing-submissions-${Date.now()}.json`, JSON.stringify(submissions, null, 2), 'application/json'));
      sortByEl.addEventListener('change', ()=>{ localStorage.setItem(STORAGE.sortBy, sortByEl.value); render(); });

      // 未来のAPI読込（雛形）
      async function fetchFromApi(force=false){
        const endpoint = apiEndpointEl.value.trim();
        if (!endpoint) return;
        try {
          loadStatus.textContent = 'APIから取得中...';
          const headers = { 'Accept':'application/json' };
          const token = apiTokenEl.value.trim();
          if (token) headers['Authorization'] = 'Bearer ' + token;
          const res = await fetch(endpoint, { headers, mode:'cors' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          // 期待: data が配列 or {items: []}
          const arr = Array.isArray(data) ? data : (Array.isArray(data.items)? data.items : []);
          submissions = [];
          let ok=0; for(const obj of arr){ try { addSubmission(obj); ok++; } catch(e){} }
          loadStatus.textContent = `APIから ${ok} 件 取得（${new Date().toLocaleString()}）`;
          render();
        } catch(e){
          loadStatus.textContent = 'API取得に失敗しました（設定・CORS確認）';
        }
      }

      // 初回自動取得
      fetchFromApi();
    })();
  </script>
</body>
</html>
