<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>持ち物管理リスト</title>
  <style>
    :root {
      --bg: #fafafa;
      --card: #ffffff;
      --text: #222;
      --muted: #666;
      --accent: #0b79d0;
      --border: #e6e6e6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN",
                   "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", "YuGothic", "Meiryo", sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 24px;
    }
    .container {
      max-width: 860px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.04);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 20px;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .field label { font-size: 13px; color: var(--muted); }
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0 12px;
    }
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn.primary { border-color: #0b79d0; color: #0b79d0; }
    .btn.danger { border-color: #d00b0b; color: #d00b0b; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .subtle { color: var(--muted); font-size: 13px; margin-bottom: 16px; }
    .section-title {
      margin: 18px 0 8px;
      font-weight: 700;
      font-size: 15px;
      color: var(--accent);
    }
    .row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dashed var(--border);
    }
    .row:last-child { border-bottom: none; }
    .label { font-weight: 600; }
    .unit { color: var(--muted); min-width: 2em; text-align: left; }
    input[type="number"] {
      width: 110px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      text-align: right;
      background: #fff;
    }
    .divider {
      margin: 18px 0;
      color: var(--muted);
      text-align: center;
      letter-spacing: 0.2em;
      font-size: 13px;
    }
    .total {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      background: #f5f8fb;
      border: 1px solid #e8eef5;
      border-radius: 10px;
      padding: 12px 14px;
      margin: 8px 0 2px;
    }
    .total .title { font-weight: 700; }
    .total .value { font-weight: 800; font-size: 18px; }
    .note { color: var(--muted); font-size: 12px; margin-bottom: 10px; }
    textarea {
      width: 100%;
      min-height: 110px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      background: #fff;
    }
    @media (max-width: 520px) {
      .row {
        grid-template-columns: 1fr auto;
      }
      .unit { grid-column: 2; justify-self: start; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>持ち物管理アプリ用リスト</h1>
    <div class="subtle">数値を入力すると自動で合計が計算されます。</div>

    <div class="toolbar">
      <button class="btn primary" id="exportJsonBtn">JSONエクスポート</button>
      <button class="btn" id="exportCsvBtn">CSVエクスポート</button>
      <label class="btn" for="importJsonInput">JSONインポート</label>
      <input type="file" id="importJsonInput" accept="application/json" style="display:none" />
      <button class="btn" id="shareLinkBtn">共有リンク生成</button>
      <button class="btn danger" id="clearBtn">保存データをクリア</button>
    </div>

    <div class="section-title">提出情報</div>
    <div class="grid-2" style="margin-bottom:10px;">
      <div class="field">
        <label for="studentName">氏名</label>
        <input type="text" id="studentName" data-key="studentName" placeholder="例：山田 太郎" />
      </div>
      <div class="field">
        <label for="studentId">受講生ID</label>
        <input type="text" id="studentId" data-key="studentId" placeholder="例：A-001" />
      </div>
    </div>
    <div class="grid-2" style="margin-bottom:10px;">
      <div class="field">
        <label for="studentClass">クラス</label>
        <input type="text" id="studentClass" data-key="studentClass" placeholder="例：第5期 平日クラス" />
      </div>
      <div class="field">
        <label for="submitEndpoint">提出先URL（管理者が配布/GASのWebアプリURL）</label>
        <input type="text" id="submitEndpoint" data-key="submitEndpoint" placeholder="https://script.google.com/.../exec" />
      </div>
    </div>
    <div class="toolbar" style="justify-content:flex-end;">
      <button class="btn primary" id="submitBtn">提出（送信）</button>
      <span id="submitStatus" class="subtle" aria-live="polite"></span>
    </div>

    <div class="section-title">衣類</div>
    <div class="row">
      <div class="label">【アウター】</div>
      <input type="number" inputmode="numeric" min="0" step="1" value="0" data-key="outer" data-group="clothes" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【トップス】</div>
      <input type="number" inputmode="numeric" min="0" step="1" value="0" data-key="tops" data-group="clothes" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【ボトムス】</div>
      <input type="number" inputmode="numeric" min="0" step="1" value="0" data-key="bottoms" data-group="clothes" />
      <div class="unit">枚</div>
    </div>

    <div class="divider">ーーーーーーーーーーーーーーーーーー</div>

    <div class="total" aria-live="polite">
      <div class="title">服の合計：</div>
      <div class="value"><span id="clothesTotal">0</span> 枚</div>
    </div>
    <div class="note">（アウター・トップス・ボトムスの合計）</div>

    <div class="divider">ーーーーーーーーーーーーーーーーーー</div>

    <div class="section-title">その他の持ち物</div>

    <div class="row">
      <div class="label">【下着】</div>
      <input type="number" min="0" step="1" value="0" data-key="underwear" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【その他衣類】</div>
      <input type="number" min="0" step="1" value="0" data-key="otherClothes" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【タオル類】</div>
      <input type="number" min="0" step="1" value="0" data-key="towels" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【靴】</div>
      <input type="number" min="0" step="1" value="0" data-key="shoes" />
      <div class="unit">足</div>
    </div>
    <div class="row">
      <div class="label">【カバン】</div>
      <input type="number" min="0" step="1" value="0" data-key="bags" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【アクセサリー/帽子】</div>
      <input type="number" min="0" step="1" value="0" data-key="accessories" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【ビューティー・ケア用品】</div>
      <input type="number" min="0" step="1" value="0" data-key="beauty" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【書籍】</div>
      <input type="number" min="0" step="1" value="0" data-key="books" />
      <div class="unit">冊</div>
    </div>
    <div class="row">
      <div class="label">【書類】</div>
      <input type="number" min="0" step="1" value="0" data-key="documents" />
      <div class="unit">冊</div>
    </div>
    <div class="row">
      <div class="label">【家具】</div>
      <input type="number" min="0" step="1" value="0" data-key="furniture" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【家電・ガジェット】</div>
      <input type="number" min="0" step="1" value="0" data-key="gadgets" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【文房具】</div>
      <input type="number" min="0" step="1" value="0" data-key="stationery" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【キッチンアイテム/ 調理道具】</div>
      <input type="number" min="0" step="1" value="0" data-key="kitchenTools" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【食器】</div>
      <input type="number" min="0" step="1" value="0" data-key="tableware" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【調味料】</div>
      <input type="number" min="0" step="1" value="0" data-key="seasonings" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【食料品（ストック）】</div>
      <input type="number" min="0" step="1" value="0" data-key="foodStock" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【洗剤】</div>
      <input type="number" min="0" step="1" value="0" data-key="detergent" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【掃除道具】</div>
      <input type="number" min="0" step="1" value="0" data-key="cleaningTools" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【医薬品・サプリメント】</div>
      <input type="number" min="0" step="1" value="0" data-key="meds" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【カード類】</div>
      <input type="number" min="0" step="1" value="0" data-key="cards" />
      <div class="unit">枚</div>
    </div>
    <div class="row">
      <div class="label">【通帳】</div>
      <input type="number" min="0" step="1" value="0" data-key="bankbooks" />
      <div class="unit">冊</div>
    </div>
    <div class="row">
      <div class="label">【雑貨・小物】</div>
      <input type="number" min="0" step="1" value="0" data-key="generalGoods" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【趣味のアイテム】</div>
      <input type="number" min="0" step="1" value="0" data-key="hobby" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【思い出の品】</div>
      <input type="number" min="0" step="1" value="0" data-key="memories" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【防災アイテム/備蓄】</div>
      <input type="number" min="0" step="1" value="0" data-key="disaster" />
      <div class="unit">個</div>
    </div>
    <div class="row">
      <div class="label">【その他】</div>
      <input type="number" min="0" step="1" value="0" data-key="others" />
      <div class="unit">個</div>
    </div>

    <div class="divider">ーーーーーーーーーーーーーー</div>

    <div class="total" aria-live="polite">
      <div class="title">持ち物全ての合計：</div>
      <div class="value"><span id="grandTotal">0</span> 個</div>
    </div>

    <div class="divider">ーーーーーーーーーーーーーー</div>

    <div class="section-title">【持ち物の傾向・価値観リスト】</div>
    <textarea data-key="traits" placeholder="例：少数精鋭、黒系が多い、用途が重複しないように選ぶ など"></textarea>

    <div class="section-title">【失敗したモノの傾向リスト】</div>
    <textarea data-key="failures" placeholder="例：サイズが合っていない、色が派手すぎた、似た用途の重複購入 など"></textarea>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = 'packingListState_v2';
      const numberInputs = Array.from(document.querySelectorAll('input[type="number"]'));
      const textareas = Array.from(document.querySelectorAll('textarea'));
      const textInputs = Array.from(document.querySelectorAll('input[type="text"]'));
      const allInputs = [...numberInputs, ...textareas, ...textInputs];
      const clothesInputs = numberInputs.filter(el => el.dataset.group === 'clothes');
      const clothesTotalEl = document.getElementById('clothesTotal');
      const grandTotalEl = document.getElementById('grandTotal');

      const exportJsonBtn = document.getElementById('exportJsonBtn');
      const exportCsvBtn = document.getElementById('exportCsvBtn');
      const importJsonInput = document.getElementById('importJsonInput');
      const shareLinkBtn = document.getElementById('shareLinkBtn');
      const clearBtn = document.getElementById('clearBtn');
      const submitBtn = document.getElementById('submitBtn');
      const submitStatus = document.getElementById('submitStatus');

      function toInt(val) {
        const n = parseInt(val, 10);
        return Number.isFinite(n) && n >= 0 ? n : 0;
      }

      function updateTotals() {
        const clothesTotal = clothesInputs.reduce((sum, el) => sum + toInt(el.value), 0);
        const grandTotal = numberInputs.reduce((sum, el) => sum + toInt(el.value), 0);
        clothesTotalEl.textContent = clothesTotal;
        grandTotalEl.textContent = grandTotal;
      }

      function getState() {
        const state = {};
        numberInputs.forEach(el => { state[el.dataset.key] = toInt(el.value); });
        textareas.forEach(el => { state[el.dataset.key] = String(el.value || ''); });
        textInputs.forEach(el => { state[el.dataset.key] = String(el.value || ''); });
        return state;
      }

      function setState(state) {
        numberInputs.forEach(el => {
          const v = state?.[el.dataset.key];
          if (typeof v === 'number' || typeof v === 'string') el.value = v;
        });
        textareas.forEach(el => {
          const v = state?.[el.dataset.key];
          if (typeof v === 'string') el.value = v;
        });
        textInputs.forEach(el => {
          const v = state?.[el.dataset.key];
          if (typeof v === 'string' || typeof v === 'number') el.value = v;
        });
        updateTotals();
      }

      function save() {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(getState())); } catch (e) {}
      }

      function restoreFromLocalStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) setState(JSON.parse(raw));
        } catch (e) {}
      }

      function download(filename, content, type='application/octet-stream') {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
      }

      function exportJSON() {
        const state = getState();
        const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        download(`packing-list-${ts}.json`, JSON.stringify(state, null, 2), 'application/json');
      }

      function rowsToCSV() {
        const rows = Array.from(document.querySelectorAll('.row'));
        const header = ['カテゴリ', '数量', '単位'];
        const lines = [header.join(',')];
        rows.forEach(r => {
          const label = (r.querySelector('.label')?.textContent || '').replace(/[\s\u3000]/g,'').replace(/[【】]/g,'');
          const unit = (r.querySelector('.unit')?.textContent || '').trim();
          const input = r.querySelector('input[type="number"]');
          const qty = input ? toInt(input.value) : 0;
          const esc = (s) => '"' + String(s).replace(/"/g,'""') + '"';
          lines.push([esc(label), qty, esc(unit)].join(','));
        });
        // 追記: テキストエリアも最後に出力
        const traits = textareas.find(t=>t.dataset.key==='traits')?.value || '';
        const failures = textareas.find(t=>t.dataset.key==='failures')?.value || '';
        lines.push('');
        lines.push('"持ち物の傾向・価値観リスト"');
        lines.push('"' + traits.replace(/"/g,'""') + '"');
        lines.push('');
        lines.push('"失敗したモノの傾向リスト"');
        lines.push('"' + failures.replace(/"/g,'""') + '"');
        return lines.join('\n');
      }

      function exportCSV() {
        const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        download(`packing-list-${ts}.csv`, rowsToCSV(), 'text/csv;charset=utf-8');
      }

      function importJSONFile(file) {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(String(reader.result || '{}'));
            setState(obj);
            save();
            alert('インポートしました');
          } catch (e) {
            alert('JSONの読み込みに失敗しました');
          }
        };
        reader.readAsText(file);
      }

      function clearStorage() {
        localStorage.removeItem(STORAGE_KEY);
        // 値をゼロ/空に戻す
        numberInputs.forEach(el => { el.value = 0; });
        textareas.forEach(el => { el.value = ''; });
        updateTotals();
      }

      function encodeStateToHash(state) {
        try {
          const json = JSON.stringify(state);
          const b64 = btoa(unescape(encodeURIComponent(json)));
          return '#data=' + b64;
        } catch (e) { return ''; }
      }

      function decodeStateFromHash(hash) {
        try {
          if (!hash.startsWith('#data=')) return null;
          const b64 = hash.slice(6);
          const json = decodeURIComponent(escape(atob(b64)));
          return JSON.parse(json);
        } catch (e) { return null; }
      }

      // イベント: 入力で合計更新 + 自動保存（軽いデバウンス）
      let t = null;
      function onAnyChange() {
        updateTotals();
        if (t) clearTimeout(t);
        t = setTimeout(save, 150);
      }
      allInputs.forEach(el => {
        el.addEventListener('input', onAnyChange, { passive: true });
        el.addEventListener('change', onAnyChange, { passive: true });
      });

      // ボタン動作
      exportJsonBtn.addEventListener('click', exportJSON);
      exportCsvBtn.addEventListener('click', exportCSV);
      importJsonInput.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) importJSONFile(f);
        e.target.value = '';
      });
      shareLinkBtn.addEventListener('click', () => {
        const hash = encodeStateToHash(getState());
        if (!hash) return alert('リンク生成に失敗しました');
        const url = location.origin + location.pathname + hash;
        navigator.clipboard?.writeText(url).then(() => {
          alert('共有リンクをクリップボードにコピーしました');
        }).catch(() => {
          prompt('以下のURLをコピーしてください', url);
        });
      });
      clearBtn.addEventListener('click', () => {
        if (confirm('保存データを削除して初期化しますか？')) clearStorage();
      });

      function collectForSubmit() {
        const state = getState();
        // すべての行（カテゴリ）を詳細として集約
        const rows = Array.from(document.querySelectorAll('.row')).map(r => {
          const label = (r.querySelector('.label')?.textContent || '').trim();
          const unit = (r.querySelector('.unit')?.textContent || '').trim();
          const input = r.querySelector('input[type="number"]');
          const qty = input ? toInt(input.value) : 0;
          return { label, unit, qty, key: input?.dataset.key || null };
        });
        const payload = {
          meta: {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: location.href
          },
            // 識別情報
          identity: {
            name: state.studentName || '',
            studentId: state.studentId || '',
            className: state.studentClass || ''
          },
          totals: {
            clothes: Number(document.getElementById('clothesTotal')?.textContent || 0),
            grand: Number(document.getElementById('grandTotal')?.textContent || 0)
          },
          notes: {
            traits: state.traits || '',
            failures: state.failures || ''
          },
          items: rows
        };
        return { payload, endpoint: state.submitEndpoint || '' };
      }

      async function submitData() {
        submitStatus.textContent = '';
        const { payload, endpoint } = collectForSubmit();
        if (!endpoint) { submitStatus.textContent = '提出先URLを入力してください'; return; }
        if (!payload.identity.name && !payload.identity.studentId) {
          submitStatus.textContent = '氏名または受講生IDを入力してください'; return;
        }
        try {
          submitBtn.disabled = true;
          submitStatus.textContent = '送信中...';
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            mode: 'cors',
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          // 期待応答: { ok: true }
          let msg = '送信しました';
          try { const j = await res.json(); if (j && j.message) msg = j.message; } catch (e) {}
          submitStatus.textContent = msg;
        } catch (e) {
          submitStatus.textContent = '送信に失敗しました。提出先URLやCORS設定を確認してください';
        } finally {
          submitBtn.disabled = false;
        }
      }
      submitBtn.addEventListener('click', submitData);

      // 初期表示: URLハッシュ優先で復元、なければLocalStorageから復元
      const fromHash = decodeStateFromHash(location.hash || '');
      if (fromHash) {
        setState(fromHash);
        save();
      } else {
        restoreFromLocalStorage();
        updateTotals();
      }
    })();
  </script>
</body>
</html>
